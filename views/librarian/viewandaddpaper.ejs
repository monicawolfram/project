<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Librarian - Manage Papers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
    <style>
        body {
            background: url('library-bg.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
        }

        .sidebar {
            background-color: white;
            min-height: 100vh;
            padding: 20px;
            border-radius: 15px;
        }

        .sidebar img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
        .sidebar .nav-link {
            color: black;
            font-size: 18px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .sidebar .nav-link:hover {
            background-color: green;
            color: white;
            border-radius: 8px;
        }

       

        .sidebar .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-link {
            color: rgb(19, 19, 19);
            font-size: 18px;
            padding: 10px 15px;
            text-align: left;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .content-container {
            background: rgba(161, 247, 122, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .tab-content {
            padding: 15px;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar here if needed -->
             <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="logo-container">
                    <img src="../images/sjcet.png" alt="SJCET Logo"> 
                    <h4>SJUCET Library</h4>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link"href="/librarian/librarian_home"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item"><a class="nav-link active"href="/librarian/librarian_category"><i class="fas fa-book"></i> Manage Catalog</a></li>
                    <li class="nav-item"><a class="nav-link"href="/librarian/managerequestlibrarian"><i class="fas fa-tasks"></i> Manage Requests</a></li>
                    <li class="nav-item"><a class="nav-link"href="/librarian/manageinventorylibrarian"><i class="fas fa-boxes"></i> Manage Inventory</a></li>
                    <li class="nav-item"><a class="nav-link"href="/librarian/massageandfeedback"><i class="fas fa-comments"></i> Messages & Feedback</a></li>
                    <li class="nav-item"><a class="nav-link"href="/librarian/generatereport"><i class="fas fa-chart-bar"></i> Generate Reports</a></li>
                    <li class="nav-item"><a class="nav-link"href="/librarian/Itsupport"><i class="fas fa-tools"></i> IT Support</a></li>
                    <li class="nav-item"><a class="nav-link"href="/librarian/manageusers"><i class="fas fa-users"></i> Manage Users</a></li>
                    <li class="nav-item"><a class="nav-link"href="/librarian/managefines"><i class="fas fa-money-bill-wave"></i> Manage Fines</a></li>
                </ul>
            </nav>
     <!-- Main Content -->
     <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            
       <!-- Top Bar -->
       <div class="top-bar d-flex justify-content-between align-items-center">
        <input type="text" class="form-control w-25" placeholder="Search here">
        <div class="d-flex align-items-center">
            <!-- Notification Dropdown -->
            <div class="dropdown me-3">
                <button class="btn btn-light dropdown-toggle" type="button" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bell"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown">
                    <li><a class="dropdown-item" href="/librarian/requestnotification">New book added</a></li>
                    <li><a class="dropdown-item" href="/librarian/requestnotification">Request pending approval</a></li>
                    <li><a class="dropdown-item" href="/librarian/systemnotification">System maintenance scheduled</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-center" href="/librarian/viewallnotification">View all</a></li>
                </ul>
            </div>

            <!-- User Dropdown -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="/librarian/librarian_account">Librarian Account</a></li>
                    <li><a class="dropdown-item" href="/librarian/admin_account">Admin Account</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="/librarian/librarian_interface">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
    
         <div class="content-container">
            <h2 class="text-center mb-4">Librarian Dashboard - Manage Papers</h2>

            <ul class="nav nav-tabs" id="libraryTabs">
                <li class="nav-item ">
                    <a class="nav-link active" id="view-papers-tab" data-bs-toggle="tab" href="/librarian/#viewPapers">View Papers</a>
                 
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="/librarian/#addPapers">Add Papers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link"  data-bs-toggle="tab" href="/librarian/#removePapers">Remove Papers</a>
                </li>
            </ul>
            <div class="tab-content mt-3">
              <!-- View Papers -->
<div class="tab-pane fade show active" id="viewPapers" role="tabpanel" aria-labelledby="view-papers-tab">
    <ul class="nav nav-pills mb-3" id="viewPapersTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="availablePapers-tab" data-bs-toggle="pill" data-bs-target="#availablePapers" type="button" role="tab" aria-controls="availablePapers" aria-selected="true">Available Papers</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="deletedPapers-tab" data-bs-toggle="pill" data-bs-target="#deletedPapers" type="button" role="tab" aria-controls="deletedPapers" aria-selected="false">Deleted Papers</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="borrowedPapers-tab" data-bs-toggle="pill" data-bs-target="#borrowedPapers" type="button" role="tab" aria-controls="borrowedPapers" aria-selected="false">Borrowed Papers</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="departments-tab" data-bs-toggle="pill" data-bs-target="#departments" type="button" role="tab" aria-controls="departments" aria-selected="false">Departments</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="newPapers-tab" data-bs-toggle="pill" data-bs-target="#newPapers" type="button" role="tab" aria-controls="newPapers" aria-selected="false">New Papers</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="updatedPapers-tab" data-bs-toggle="pill" data-bs-target="#updatedPapers" type="button" role="tab" aria-controls="updatedPapers" aria-selected="false">Recently Updated Papers</button>
        </li>
    </ul>

    <div class="tab-content" id="viewPapersContent">
        <div class="tab-pane fade show active" id="availablePapers" role="tabpanel" aria-labelledby="availablePapers-tab">
            <div id="availablePapersList" class="row"></div>
        </div>
        <div class="tab-pane fade" id="deletedPapers" role="tabpanel" aria-labelledby="deletedPapers-tab">
            <div id="deletedPapersList" class="row"></div>
        </div>
        <div class="tab-pane fade" id="borrowedPapers" role="tabpanel" aria-labelledby="borrowedPapers-tab">
            <div id="borrowedPapersList" class="row"></div>
        </div>
        <div class="tab-pane fade" id="departments" role="tabpanel" aria-labelledby="departments-tab">
            <div id="departmentsList" class="row"></div>
        </div>
        <div class="tab-pane fade" id="newPapers" role="tabpanel" aria-labelledby="newPapers-tab">
            <p>Recently added papers will be displayed here.</p>
        </div>
        <div class="tab-pane fade" id="updatedPapers" role="tabpanel" aria-labelledby="updatedPapers-tab">
            <p>Recently updated paper details will be displayed here.</p>
        </div>
    </div>
</div>

             <!-- Add Papers Section -->
<div class="tab-pane fade" id="addPapers" role="tabpanel" aria-labelledby="add-papers-tab">
    <h4 class="text-center">Add a New Paper</h4>
    <form id="addPaperForm" method="POST" action="/librarian/papers/add" enctype="multipart/form-data">
        <div class="mb-3">
            <label class="form-label">Paper Cover Image</label>
            <input type="file" class="form-control" name="paper_image" accept="image/*" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" name="title" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Author</label>
            <input type="text" class="form-control" name="author" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Department</label>
            <input type="text" class="form-control" name="department" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="date_added" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Paper Code</label>
            <div class="input-group">
                <input type="text" class="form-control" name="paper_code" id="paperCode" readonly required>
                <button type="button" class="btn btn-primary" onclick="generatePaperCode()">Generate Code</button>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Shelf Number</label>
            <input type="number" class="form-control" name="shelf_no" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Drawer Number</label>
            <input type="number" class="form-control" name="draw_no" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Year</label>
            <input type="number" class="form-control" name="year" required>
        </div>
        <input type="hidden" name="to_json" value="true">
        <button type="submit" class="btn btn-success">Submit</button>
    </form>
</div>


                    
<!-- Remove Papers Section -->
<div class="tab-pane fade" id="removePapers" role="tabpanel" aria-labelledby="remove-papers-tab">
    <h4 class="text-center">Remove a Paper</h4>
    <!-- Search Form -->
    <form onsubmit="return false;">
        <div class="mb-3">
            <label class="form-label">Enter Paper Code or Title</label>
            <div class="input-group">
                <input type="text" class="form-control" id="searchPaper" placeholder="Paper code or title">
                <a href="#" class="btn btn-secondary" onclick="searchPaper(); return false;">Search</a>
            </div>
        </div>
    </form>

    <!-- Results Table -->
    <div id="searchResults" class="d-none">
        <h5>Search Results</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Paper Code</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody"></tbody>
        </table>
    </div>

    <script>
        function searchPaper() {
            const searchInput = document.getElementById("searchPaper").value.trim();
            if (!searchInput) {
                alert("Please enter a paper code or title.");
                return;
            }
            fetch(`http://localhost:3000/librarian/search/paper?q=${encodeURIComponent(searchInput)}`)
                .then(response => response.json())
                .then(data => {
                    const resultsTable = document.getElementById("searchResults");
                    const tbody = document.getElementById("resultsTableBody");
                    tbody.innerHTML = "";

                    if (data.success && data.papers.length > 0) {
                        data.papers.forEach(paper => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${paper.paper_code}</td>
                                <td>${paper.title}</td>
                                <td>${paper.author}</td>
                                <td>
                                    <!-- Soft Delete Button -->
                                    <button class="btn btn-warning btn-sm" onclick="softDeletePaper(${paper.id})">
                                        <i class="fas fa-ban"></i>
                                    </button>

                                    <!-- Hard Delete Button -->
                                    <button class="btn btn-danger btn-sm" onclick="hardDeletePaper(${paper.id})">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        resultsTable.classList.remove("d-none");
                    } else {
                        alert("No papers found.");
                        resultsTable.classList.add("d-none");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Something went wrong while searching.");
                });
        }

        function softDeletePaper(paperId) {
            if (!confirm("Are you sure you want to hide this paper?")) return;

            fetch(`/librarian/delete/paper/${paperId}`, {
                method: 'DELETE'
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || "Paper hidden.");
                    searchPaper(); // refresh list
                })
                .catch(err => {
                    console.error("Error:", err);
                    alert("Failed to hide paper.");
                });
        }

        function hardDeletePaper(paperId) {
            if (!confirm("Are you sure you want to permanently delete this paper?")) return;

            fetch(`/librarian/remove/paper/${paperId}`, {
                method: 'DELETE'
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || "Paper permanently deleted.");
                    searchPaper(); // refresh list
                })
                .catch(err => {
                    console.error("Error:", err);
                    alert("Failed to permanently delete paper.");
                });
        }
    </script>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    fetch('/librarian/papers/available')
    .then(res => res.json())
    .then(papers => {
        const container = document.getElementById('availablePapersList');
        container.innerHTML = '';

        if (!papers.length) {
            container.innerHTML = '<p>No available papers found.</p>';
            return;
        }

        papers.forEach(paper => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-3';
            card.innerHTML = `
                <div class="card h-100 shadow-sm">
                    <img src="/uploads/papers/${paper.image}" class="card-img-top" alt="${paper.title}" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <h5 class="card-title">${paper.title}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${paper.author}</h6>
                        <p class="card-text"><strong>Department:</strong> ${paper.department}</p>
                        <p class="card-text"><strong>Drawer No:</strong> ${paper.draw_no}</p>
                        <p class="card-text"><strong>Shelf No:</strong> ${paper.shelf_no}</p>
                    </div>
                </div>`;
            container.appendChild(card);
        });
    })
    .catch(err => {
        console.error('Error fetching papers:', err);
        document.getElementById('availablePapersList').innerHTML = '<p>Error loading papers.</p>';
    });
});

async function generatePaperCode() {
    try {
        const res = await fetch('/librarian/generate-paper-code');
        const data = await res.json();
        document.getElementById("paperCode").value = data.paperCode;
    } catch (err) {
        console.error('Failed to generate paper code:', err);
        alert('Could not generate paper code. Please try again.');
    }
}

function searchPaper() {
    const query = document.getElementById("searchPaper").value.trim();
    if (!query) {
        alert("Please enter a paper code or title.");
        return;
    }
    fetch(`/librarian/search/paper?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            const resultsSection = document.getElementById("searchResults");
            const tbody = document.getElementById("resultsTableBody");
            tbody.innerHTML = "";

            if (data.success && data.papers.length > 0) {
                data.papers.forEach(paper => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${paper.paper_code}</td>
                        <td>${paper.title}</td>
                        <td>${paper.author}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="softDeletePaper(${paper.id})">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="hardDeletePaper(${paper.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>`;
                    tbody.appendChild(row);
                });
                resultsSection.classList.remove("d-none");
            } else {
                alert("No papers found.");
                resultsSection.classList.add("d-none");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Something went wrong while searching.");
        });
}

function softDeletePaper(paperId) {
    if (!confirm("Are you sure you want to hide this paper?")) return;

    fetch(`/librarian/delete/paper/${paperId}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            alert(data.message || "Paper hidden.");
            searchPaper();
        })
        .catch(err => {
            console.error(err);
            alert("Failed to hide paper.");
        });
}

function hardDeletePaper(paperId) {
    if (!confirm("Are you sure you want to permanently delete this paper?")) return;

    fetch(`/librarian/remove/paper/${paperId}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            alert(data.message || "Paper permanently deleted.");
            searchPaper();
        })
        .catch(err => {
            console.error(err);
            alert("Failed to permanently delete paper.");
        });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
